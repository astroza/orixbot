/* Orixbot - config.c * Felipe Astroza * Under GPLv2 (see LICENSE) */#include <ctype.h>#include <string.h>#include <libxml/parser.h>#include <libxml/xmlmemory.h>#include <orix/net.h>#include <orix/log.h>#include <orix/config.h>#include <orix/modules.h>#include <orix/irc.h>#include <orix/server.h>static unsigned short str_to_port(const char *str, unsigned short default_p){	int ret;	if(str == NULL)		return default_p;	ret = strtol(str, NULL, 10);	if(ret == 0 || ret & 0xfff0000) /* ret and 0xfff0000 puedo revisar si esta prendido algun bit sobre el bit 16					 * verificando que no sea mas largo que una word */		return default_p;	return (unsigned short) ret;}static void cfg_parse_core(xmlDocPtr doc, xmlNodePtr cur){	orix_server scfg;	scfg.inet_bindaddr = DEFAULT_ADDR;	scfg.inet_port = DEFAULT_PORT;	scfg.unix_bindaddr = DEFAULT_UNIXDOMAIN;	for(cur = cur->xmlChildrenNode; cur; cur = cur->next) {		if(xmlStrcmp(cur->name, (const xmlChar *)"mods_path") == 0)			set_mods_path((char *)xmlStrdup(cur->xmlChildrenNode->content));				else if(xmlStrcmp(cur->name, (const xmlChar *)"inet_bindaddr") == 0)			scfg.inet_bindaddr = (char *)cur->xmlChildrenNode->content;		else if(xmlStrcmp(cur->name, (const xmlChar *)"unix_bindaddr") == 0)			scfg.unix_bindaddr = (char *)cur->xmlChildrenNode->content;		else if(xmlStrcmp(cur->name, (const xmlChar *)"inet_port") == 0)			scfg.inet_port = str_to_port((char *)cur->xmlChildrenNode->content, DEFAULT_PORT);		else if(xmlStrcmp(cur->name, (const xmlChar *)"max_connections") == 0)			set_max_connections(atoi((char *)cur->xmlChildrenNode->content));	}	if(net_ctl(NCTL_INITSERVER, &scfg) == NULL) {		orix_log(ERROR, "%s(%s): Can't initiate server", __FUNCTION__, doc->name);		exit(EXIT_FAILURE);	}}	static int cfg_parse_bot(xmlDocPtr doc, xmlNodePtr cur){	const char fmt[] = "%s(%s): You must set the \"%s\" in line %d";	char *nick, *user, *database, *server, *aux;	orix_bot *bot;	nick = (char *)xmlGetProp(cur, (xmlChar *)"nick");	if(!nick) {		orix_log(ERROR, fmt, __FUNCTION__, doc->name, "nick", cur->line);		return 0;	}	user = (char *)xmlGetProp(cur, (xmlChar *)"user");	if(!user) {		orix_log(ERROR, fmt, __FUNCTION__, doc->name, "user", cur->line);		return 0;	}	database = (char *)xmlGetProp(cur, (xmlChar *)"database");	if(!database) {		orix_log(ERROR, fmt, __FUNCTION__, doc->name, "database", cur->line);		return 0;	}	server = (char *)xmlGetProp(cur, (xmlChar *)"server");	if(!server) {		orix_log(ERROR, fmt, __FUNCTION__, doc->name, "server", cur->line);		return 0;	}	aux = strrchr(server, ':');	bot = new_bot(nick, user, database, server, str_to_port(aux? aux + 1 : NULL, 6667));	bot_add(bot);	xmlFree(nick);	xmlFree(user);	xmlFree(database);	xmlFree(server);	/* Modulos adicionales */	for(cur = cur->xmlChildrenNode; cur; cur = cur->next) {		if(xmlStrcmp(cur->name, (xmlChar *)"module") == 0)			mod_load(bot, (char *)cur->xmlChildrenNode->content);		else if(xmlStrcmp(cur->name, (xmlChar *)"join") == 0)			irc_join(BOTSOCKET(bot), (char *)cur->xmlChildrenNode->content);				}	return 1;}void cfg_parse_file(const char *file){	xmlDocPtr doc;	xmlNodePtr cur, root;	doc = xmlParseFile(file);	if(doc == NULL) {		fprintf(stderr, "%s(%s): Can't open file\n", __FUNCTION__, file);		exit(EXIT_FAILURE);	}	root = xmlDocGetRootElement(doc);	if(root == NULL) {		fprintf(stderr, "%s(%s): Empty file\n", __FUNCTION__, file);		exit(EXIT_FAILURE);	}	if(xmlStrcmp(root->name, (const xmlChar *) "orix") != 0) {		fprintf(stderr, "%s(%s) Root node invalid (need orix)\n", __FUNCTION__, file);		exit(EXIT_FAILURE);	}	cur = root->xmlChildrenNode;	while(cur != NULL) {		if(xmlStrcmp(cur->name, (const xmlChar *)"core") == 0) {			cfg_parse_core(doc, cur);			break;		}		cur = cur->next;	}	/* Segunda pasada, una vez obtenida la configuracion principal, continuo con los bots */	cur = root->xmlChildrenNode;	while(cur != NULL) {		if(xmlStrcmp(cur->name, (const xmlChar *)"bot") == 0) 			cfg_parse_bot(doc, cur);		cur = cur->next;	}	xmlFreeDoc(doc);}int cfg_parse_bot_file(const char *file){	xmlDocPtr doc;	xmlNodePtr cur;	if(!file || !*file)		return 0;	doc = xmlParseFile(file);	if(doc == NULL) {		orix_log(ERROR, "%s(): Cant open file %s", __FUNCTION__, file);		return 0;	}	cur = xmlDocGetRootElement(doc);        if(cur == NULL) {                orix_log(ERROR, "%s(%s): Empty file", __FUNCTION__, file);                return 0;        }	while(cur) {		if(xmlStrcmp(cur->name, (const xmlChar *) "bot") == 0) {			cfg_parse_bot(doc, cur);			printf("un bot\n");		}		cur = cur->next;	}	xmlFreeDoc(doc);	return 1;}